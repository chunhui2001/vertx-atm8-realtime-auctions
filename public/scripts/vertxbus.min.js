!function(a){if("function"==typeof require&&"undefined"!=typeof module){var b=require("sockjs-client");if(!b)throw new Error("vertx-eventbus.js requires sockjs-client, see http://sockjs.org");a(b)}else if("function"==typeof define&&define.amd)define("vertx-eventbus",["sockjs"],a);else{if(void 0===this.SockJS)throw new Error("vertx-eventbus.js requires sockjs-client, see http://sockjs.org");EventBus=a(this.SockJS)}}(function(a){function b(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a,b){return b=16*Math.random(),("y"==a?3&b|8:0|b).toString(16)})}function c(a,b){if(a){if(!b)return a;for(var c in a)a.hasOwnProperty(c)&&void 0===b[c]&&(b[c]=a[c])}return b||{}}var d=function(b,c){var e=this;c=c||{},this.pingInterval=c.vertxbus_ping_interval||5e3,this.pingTimerID=null,this.sockJSConn=new a(b,null,c),this.state=d.CONNECTING,this.handlers={},this.replyHandlers={},this.defaultHeaders=null,this.onerror=function(a){try{console.error(a)}catch(b){}},this.sockJSConn.onopen=function(){e.pingEnabled(!0),e.state=d.OPEN,e.onopen&&e.onopen()},this.sockJSConn.onclose=function(a){e.state=d.CLOSED,e.pingTimerID&&clearInterval(e.pingTimerID),e.onclose&&e.onclose(a)},this.sockJSConn.onmessage=function(a){var b=JSON.parse(a.data);if(b.replyAddress&&Object.defineProperty(b,"reply",{value:function(a,c,d){e.send(b.replyAddress,a,c,d)}}),e.handlers[b.address])for(var c=e.handlers[b.address],d=0;d<c.length;d++)"err"===b.type?c[d]({failureCode:b.failureCode,failureType:b.failureType,message:b.message}):c[d](null,b);else if(e.replyHandlers[b.address]){var f=e.replyHandlers[b.address];delete e.replyHandlers[b.address],"err"===b.type?f({failureCode:b.failureCode,failureType:b.failureType,message:b.message}):f(null,b)}else if("err"===b.type)e.onerror(b);else try{console.warn("No handler found for message: ",b)}catch(a){}}};if(d.prototype.send=function(a,e,f,g){if(this.state!=d.OPEN)throw new Error("INVALID_STATE_ERR");"function"==typeof f&&(g=f,f={});var h={type:"send",address:a,headers:c(this.defaultHeaders,f),body:e};if(g){var i=b();h.replyAddress=i,this.replyHandlers[i]=g}this.sockJSConn.send(JSON.stringify(h))},d.prototype.publish=function(a,b,e){if(this.state!=d.OPEN)throw new Error("INVALID_STATE_ERR");this.sockJSConn.send(JSON.stringify({type:"publish",address:a,headers:c(this.defaultHeaders,e),body:b}))},d.prototype.registerHandler=function(a,b,e){if(this.state!=d.OPEN)throw new Error("INVALID_STATE_ERR");"function"==typeof b&&(e=b,b={}),this.handlers[a]||(this.handlers[a]=[],this.sockJSConn.send(JSON.stringify({type:"register",address:a,headers:c(this.defaultHeaders,b)}))),this.handlers[a].push(e)},d.prototype.unregisterHandler=function(a,b,e){if(this.state!=d.OPEN)throw new Error("INVALID_STATE_ERR");var f=this.handlers[a];if(f){"function"==typeof b&&(e=b,b={});var g=f.indexOf(e);-1!=g&&(f.splice(g,1),0===f.length&&(this.sockJSConn.send(JSON.stringify({type:"unregister",address:a,headers:c(this.defaultHeaders,b)})),delete this.handlers[a]))}},d.prototype.close=function(){this.state=d.CLOSING,this.sockJSConn.close()},d.CONNECTING=0,d.OPEN=1,d.CLOSING=2,d.CLOSED=3,d.prototype.pingEnabled=function(a){var b=this;if(a){var c=function(){b.sockJSConn.send(JSON.stringify({type:"ping"}))};b.pingInterval>0&&(c(),b.pingTimerID=setInterval(c,b.pingInterval))}else b.pingTimerID&&(clearInterval(b.pingTimerID),b.pingTimerID=null)},"undefined"==typeof exports)return d;"undefined"!=typeof module&&module.exports?exports=module.exports=d:exports.EventBus=d});